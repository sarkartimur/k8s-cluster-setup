BOX = "ubuntu/xenial64"
PROVIDER = "virtualbox"
NET_MASK = "10.244.0.0"
ADDRESS_PREFIX = "10.1.0."
MASTER_IP = ADDRESS_PREFIX + "100"
METALLB_ADDRESS_RANGE = ADDRESS_PREFIX + "200-" + ADDRESS_PREFIX + "254"
WORKER_COUNT = 2
WORKER_MEMORY = 1024
WORKER_CPU = 1

Vagrant.configure("2") do |config|
    config.ssh.insert_key = false
      
    config.vm.define "k8s-master" do |master|
        master.vm.box = BOX
        master.vm.provider PROVIDER do |p|
            p.memory = 2048
            p.cpus = 2
        end
        master.vm.network "private_network", ip: MASTER_IP
        master.vm.hostname = "k8s-master"
        master.vm.provision "ansible_local" do |ansible|
            ansible.playbook = "playbooks/master-playbook.yml"
            ansible.verbose = "vvv"
            ansible.extra_vars = {
                master_ip: MASTER_IP,
                net_mask: NET_MASK,
                node_name: master.vm.hostname,
                node_ip: MASTER_IP,
                metallb_address_range: METALLB_ADDRESS_RANGE
            }
        end
    end

    (1..WORKER_COUNT).each do |i|
        config.vm.define "node-#{i}" do |node|
            node.vm.box = BOX
            node.vm.provider PROVIDER do |p|
                p.memory = WORKER_MEMORY
                p.cpus = WORKER_CPU
            end
            worker_ip_suf = 100 + i
            worker_ip = ADDRESS_PREFIX + "#{worker_ip_suf}"
            node.vm.network "private_network", ip: worker_ip
            node.vm.hostname = "node-#{i}"
            node.vm.provision "ansible_local" do |ansible|
                ansible.playbook = "playbooks/node-playbook.yml"
                ansible.extra_vars = {
                    master_ip: MASTER_IP,
                    node_name: node.vm.hostname,
                    node_ip: worker_ip
                }
            end
        end
    end
end